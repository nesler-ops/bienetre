<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sant√© Mentale - PHQ-9</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
      }

      nav {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 56px;
        background-color: #3b82f6;
        color: white;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }

      nav img {
        height: 30px;
        max-width: 100px;
      }

      nav a {
        color: white;
        text-decoration: none;
        white-space: nowrap;
      }

      .container {
        max-width: 900px;
        margin: 80px auto 40px;
        padding: 0 20px;
      }

      .btn-retour {
        display: inline-block;
        margin-bottom: 20px;
        color: #2563eb;
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.95rem;
      }

      .intro,
      .questionnaire {
        background: white;
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 32px;
        transition: all 0.2s ease-in-out;
      }

      .intro:hover,
      .questionnaire:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
      }

      .intro-icon {
        font-size: 36px;
        color: #ec4899;
        vertical-align: middle;
      }

      .intro h1 {
        display: inline-block;
        margin-left: 12px;
        font-size: 1.8rem;
        color: #1f2937;
      }

      h2 {
        color: #1f2937;
        font-size: 1.4rem;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      label {
        font-weight: 500;
        color: #374151;
      }

      select {
        padding: 10px;
        margin-top: 5px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        font-size: 0.95rem;
      }

      button {
        background-color: #10b981;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 25px;
        padding: 12px 24px;
        font-size: 1rem;
        border-radius: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        transition: 0.2s ease;
      }

      button:hover {
        background-color: #059669;
        transform: scale(1.03);
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
      }

      .result a {
        text-decoration: underline;
      }

      .light {
        background: #ecfdf5;
        color: #047857;
      }

      .moderate {
        background: #fffbeb;
        color: #92400e;
      }

      .severe {
        background: #fef2f2;
        color: #991b1b;
      }

      .footer {
        text-align: center;
        margin-top: 40px;
        font-size: 0.9rem;
        color: gray;
      }
    </style>
  </head>
  <body>
    <nav
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 56px;
        background-color: #3b82f6;
        color: white;
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: sans-serif;
        font-size: 0.9rem;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      "
    >
      <!-- üü¶ Bloque Izquierdo: Logo -->
      <div style="flex: 0 0 auto; display: flex; align-items: center">
        <a
          href="http://localhost:5173/"
          style="display: flex; align-items: center"
        >
          <img
            src="/static/BE.png"
            alt="BIEN-√äTRE+"
            style="height: 30px; max-width: 100px"
            onerror="this.style.display='none'"
          />
        </a>
      </div>

      <!-- üü™ Bloque Centro: Clima -->
      <div
        style="
          flex: 1;
          text-align: center;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          padding: 0 10px;
        "
      >
        <span id="weatherInfo">üå° Chargement...</span>
      </div>

      <!-- üü© Bloque Derecho: Connexion -->
      <div style="flex: 0 0 auto; display: flex; gap: 16px">
        <a
          href="http://localhost:5173/login"
          style="color: white; text-decoration: none"
          >Se connecter</a
        >
        <a
          href="http://localhost:5173/register-patient"
          style="color: white; text-decoration: none"
          >S'inscrire</a
        >
      </div>
    </nav>

    <div class="container">
      <div
        class="btn-retour"
        onclick="window.location.href='http://localhost:5173/'"
      >
        ‚Üê Retour √† l'accueil
      </div>

      <div class="intro">
        <span class="intro-icon">üß†</span>
        <h1>Sant√© mentale</h1>
        <p style="margin-top: 10px">
          Prendre soin de sa sant√© mentale est aussi important que la sant√©
          physique. Il est essentiel de reconna√Ætre le stress, l'anxi√©t√© et
          d'apprendre √† les g√©rer.
        </p>
      </div>

      <div class="questionnaire">
        <h2>üß† Questionnaire PHQ-9</h2>
        <p style="font-size: 0.95rem; margin-bottom: 20px">
          Au cours des deux derni√®res semaines, √† quelle fr√©quence avez-vous √©t√©
          d√©rang√© par les probl√®mes suivants ?
        </p>

        <form id="phqForm">
          <div id="questionsContainer">
            <!-- Les questions seront g√©n√©r√©es dynamiquement ici -->
          </div>
          <button type="submit">‚úî √âvaluer maintenant</button>
        </form>

        <div id="resultat" class="result" style="display: none"></div>
      </div>

      <p class="footer">
        ‚ö†Ô∏è Les r√©sultats sont √† titre informatif uniquement. Consultez un
        professionnel en cas de doute ou de besoin.
      </p>
    </div>

    <script>
      // Configuration - Remplacez cette cl√© par votre propre cl√© API
      const API_KEY = "VITE_WEATHER_API_KEY";

      // Script pour l'API m√©t√©o
      const weatherSpan = document.getElementById("weatherInfo");

      const fetchWeatherAndTime = async (lat, lon) => {
        try {
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${API_KEY}&lang=fr`
          );
          const data = await response.json();

          const temp = data.main.temp.toFixed(1);
          const desc = data.weather[0].description;
          const city = data.name;
          const offset = data.timezone;

          const nowUTC = new Date();
          const utcTime = nowUTC.getTime() + nowUTC.getTimezoneOffset() * 60000;
          const local = new Date(utcTime + offset * 1000);
          const timeStr = local.toLocaleTimeString("fr-FR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          weatherSpan.innerHTML = `üå° ${temp}¬∞C ‚Äì ${desc} √† ${city} | üïí ${timeStr}`;
        } catch (e) {
          console.error("Erreur m√©t√©o:", e);
          weatherSpan.innerText = "üå° Info m√©t√©o non disponible";
        }
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) =>
            fetchWeatherAndTime(pos.coords.latitude, pos.coords.longitude),
          () => fetchWeatherAndTime(45.5017, -73.5673)
        );
      } else {
        fetchWeatherAndTime(45.5017, -73.5673);
      }

      // G√©n√©ration des questions du formulaire
      const questions = [
        "Peu d'int√©r√™t ou de plaisir √† faire les choses",
        "Vous vous sentez d√©prim√©, triste ou sans espoir",
        "Difficult√©s √† vous endormir ou √† rester endormi, ou trop dormir",
        "Fatigue ou manque d'√©nergie",
        "Perte d'app√©tit ou trop manger",
        "Vous sentez-vous mal dans votre peau, ou pensez que vous √™tes un √©chec",
        "Difficult√©s √† vous concentrer sur des choses, comme lire le journal ou regarder la t√©l√©vision",
        "Bougez ou parlez si lentement que les autres l'ont remarqu√©. Ou bien, √™tes-vous si agit√© que vous bougez beaucoup plus que d'habitude",
        "Avez-vous eu des pens√©es que vous seriez mieux mort ou de vous faire du mal d'une mani√®re ou d'une autre",
      ];

      const container = document.getElementById("questionsContainer");
      questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${i + 1}. ${q}</label>
          <select name="q${i}" required>
            <option value="0">Pas du tout (0)</option>
            <option value="1">Plusieurs jours (1)</option>
            <option value="2">Plus de la moiti√© des jours (2)</option>
            <option value="3">Presque tous les jours (3)</option>
          </select>
          <br/><br/>
        `;
        container.appendChild(div);
      });

      // Gestion de la soumission du formulaire
      document
        .getElementById("phqForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const scores = Array.from({ length: 9 }, (_, i) =>
            parseInt(formData.get(`q${i}`))
          );

          try {
            const response = await fetch("http://localhost:8000/mental/phq9", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ scores }),
            });

            const data = await response.json();
            const resultatDiv = document.getElementById("resultat");
            resultatDiv.style.display = "block";

            const niveau = data.niveau;
            let conseils = "";

            if (niveau.includes("s√©v√®re")) {
              resultatDiv.className = "result severe";
              conseils = `
            üÜò Il est fortement conseill√© de consulter un professionnel de sant√© mentale.<br/>
            <a href="https://www.doctolib.fr/psychiatre" target="_blank">Trouver un psychiatre sur Doctolib</a>
          `;
            } else if (niveau.includes("mod√©r√©")) {
              resultatDiv.className = "result moderate";
              conseils = `
            üí° Essayez des techniques de relaxation comme le yoga ou la m√©ditation.<br/>
            <a href="https://www.headspace.com/fr" target="_blank">D√©couvrir des m√©ditations guid√©es (Headspace)</a>
          `;
            } else {
              resultatDiv.className = "result light";
              conseils = `
            üå± Votre √©tat est stable. Continuez √† prendre soin de votre bien-√™tre mental.<br/>
            <a href="https://www.petitbambou.com/fr/" target="_blank">Pratiquer la pleine conscience (Petit Bambou)</a>
          `;
            }

            resultatDiv.innerHTML = `<strong>${data.resultat}</strong><br/><br/>${conseils}`;
          } catch (err) {
            console.error("Erreur formulaire:", err);
            alert("Erreur lors de l'√©valuation. Veuillez r√©essayer.");
          }
        });
    </script>
  </body>
</html>
